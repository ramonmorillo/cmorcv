<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Herramienta seguimiento CMO para RCV</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">CMO</div>
        <div class="brandText">
          <div class="brandTitle">Seguimiento CMO</div>
          <div class="brandSub">Riesgo Cardiovascular ¬∑ Local-first</div>
        </div>
      </div>

      <nav class="nav">
        <button class="navBtn active" data-view="patientsView">
          <span class="navIcon">üë•</span><span>Pacientes</span>
        </button>
        <button class="navBtn" data-view="dashboardView">
          <span class="navIcon">üìä</span><span>Dashboard</span>
        </button>
        <button class="navBtn" data-view="interventionsView">
          <span class="navIcon">üíä</span><span>Intervenciones</span>
        </button>
        <button class="navBtn" data-view="exportsView">
          <span class="navIcon">üì§</span><span>Exportaci√≥n</span>
        </button>
        <button class="navBtn" data-view="aboutView">
          <span class="navIcon">üß©</span><span>Ayuda</span>
        </button>
      </nav>

      <div class="sidebarFooter">
        <div class="smallMuted" style="font-weight:700;color:var(--text)">Creado por Ramon Morillo</div>
        <div class="smallMuted">Febrero 2026</div>
        <div class="smallMuted" style="margin-top:6px">Datos guardados localmente (IndexedDB). Backup periodico recomendado.</div>
        <button class="authBtn" id="btnAuthorship" aria-haspopup="dialog">‚Ñπ Autor√≠a y uso</button>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topbarLeft">
          <div class="pageTitle" id="pageTitle">Pacientes</div>
          <div class="pageHint" id="pageHint">Registro longitudinal con CMO + exportaci√≥n para investigaci√≥n</div>
        </div>

        <div class="topbarRight">
          <button class="btn ghost" id="btnQuickBackup" title="Backup JSON (recomendado)">
            ‚¨áÔ∏è Backup
          </button>
          <button class="btn" id="btnNewPatient">+ Nuevo paciente</button>
        </div>
      </header>

      <div id="toast" class="toast hidden"></div>

      <section id="patientsView" class="view">
        <div class="panel">
          <div class="panelHeader">
            <div class="panelTitle">Listado</div>
            <div class="panelActions">
              <input id="patientSearch" class="input" placeholder="Buscar por ID, patolog√≠a, notas..." />
              <select id="conditionFilter" class="select">
                <option value="">Todas las patolog√≠as</option>
              </select>
            </div>
          </div>

          <div class="grid">
            <div class="card">
              <div class="cardHeader">
                <div class="cardTitle">Pacientes</div>
                <div class="badge" id="patientsCount">0</div>
              </div>
              <div class="cardBody">
                <div class="statRow">
                  <div class="stat">
                    <div class="statLabel">Activos</div>
                    <div class="statValue" id="statActive">0</div>
                  </div>
                  <div class="stat">
                    <div class="statLabel">Con ‚â•1 visita</div>
                    <div class="statValue" id="statWithVisits">0</div>
                  </div>
                  <div class="stat">
                    <div class="statLabel">√öltimo backup</div>
                    <div class="statValue small" id="statLastBackup">‚Äî</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card span2">
              <div class="cardHeader">
                <div class="cardTitle">Tabla</div>
                <div class="smallMuted">Click en un paciente para abrir ficha</div>
              </div>
              <div class="cardBody">
                <div class="tableWrap">
                  <table class="table" id="patientsTable">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Patolog√≠a</th>
                        <th>Sexo</th>
                        <th>Nac.</th>
                        <th>√öltima visita</th>
                        <th>Nivel</th>
                        <th>Score</th>
                        <th>LDL √∫ltimo</th>
                        <th>Objetivo</th>
                        <th>Estado</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid">
            <div class="card span3 hidden" id="patientDetailCard">
              <div class="cardHeader">
                <div class="cardTitle" id="patientDetailTitle">Ficha</div>
                <div class="cardActions">
                  <button class="btn ghost" id="btnBackToList">‚Üê Volver</button>
                  <button class="btn" id="btnNewVisit">+ Nueva visita</button>
                  <button class="btn danger" id="btnDeletePatient">Eliminar paciente</button>
                </div>
              </div>

              <div class="cardBody">
                <div class="detailGrid">
                  <div class="detailSection">
                    <div class="sectionTitle">Resumen</div>
                    <div class="kv">
                      <div class="k">ID</div><div class="v" id="d_patientId">‚Äî</div>
                      <div class="k">Patolog√≠a</div><div class="v" id="d_condition">‚Äî</div>
                      <div class="k">Sexo</div><div class="v" id="d_sex">‚Äî</div>
                      <div class="k">A√±o nac.</div><div class="v" id="d_birthYear">‚Äî</div>
                      <div class="k">Comorbilidades</div><div class="v" id="d_comorb">‚Äî</div>
                      <div class="k">Notas</div><div class="v" id="d_notes">‚Äî</div>
                    </div>
                  </div>

                  <div class="detailSection">
                    <div class="sectionTitle">Dashboard</div>
                    <div class="dashRow">
                      <div class="miniCard">
                        <div class="miniLabel">Nivel actual</div>
                        <div class="miniValue" id="d_levelNow">‚Äî</div>
                        <div class="miniHint" id="d_levelWhy">‚Äî</div>
                      </div>
                      <div class="miniCard">
                        <div class="miniLabel">Score actual</div>
                        <div class="miniValue" id="d_scoreNow">‚Äî</div>
                        <div class="miniHint">Cortes: ‚â•23‚ÜíN1; ‚â•17‚ÜíN2</div>
                      </div>
                      <div class="miniCard">
                        <div class="miniLabel">LDL √∫ltimo</div>
                        <div class="miniValue" id="d_ldlLast">‚Äî</div>
                        <div class="miniHint" id="d_ldlGoal">‚Äî</div>
                      </div>
                    </div>

                    <div class="chartWrap">
                      <canvas id="ldlChart" width="900" height="240"></canvas>
                      <div class="smallMuted">Evoluci√≥n LDL (mg/dL). (Gr√°fico local, sin librer√≠as externas).</div>
                    </div>
                  </div>
                </div>

                <div class="divider"></div>

                <div class="sectionTitle">Visitas</div>
                <div class="tableWrap">
                  <table class="table" id="visitsTable">
                    <thead>
                      <tr>
                        <th>Fecha</th>
                        <th>F√°rmaco hospitalario</th>
                        <th>LDL</th>
                        <th>Objetivo</th>
                        <th>¬øCumple?</th>
                        <th>Score</th>
                        <th>Nivel</th>
                        <th>Tratamiento (texto)</th>
                        <th>Adherencia</th>
                        <th>RAM</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <section id="dashboardView" class="view hidden">
        <!-- Row 1: Summary cards -->
        <div class="dashRow dashRow4">
          <div class="miniCard miniCard--accent">
            <div class="miniLabel">En seguimiento activo</div>
            <div class="miniValue" id="dash_active">0</div>
            <div class="miniHint" id="dash_activePct"></div>
          </div>
          <div class="miniCard miniCard--green">
            <div class="miniLabel">Con visitas registradas</div>
            <div class="miniValue" id="dash_withVisits">0</div>
            <div class="miniHint" id="dash_withVisitsPct"></div>
          </div>
          <div class="miniCard miniCard--teal">
            <div class="miniLabel">Objetivo LDL alcanzado</div>
            <div class="miniValue" id="dash_goalYes">0</div>
            <div class="miniHint" id="dash_goalYesPct"></div>
          </div>
          <div class="miniCard miniCard--orange">
            <div class="miniLabel">Intervenciones pendientes</div>
            <div class="miniValue" id="dash_pendingIV">0</div>
            <div class="miniHint" id="dash_pendingIVHint"></div>
          </div>
        </div>

        <!-- Row 2: Visual charts -->
        <div class="grid grid3">
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Objetivo LDL</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartGoalDonut" width="260" height="200"></canvas>
              <div class="chartLegend" id="legendGoal"></div>
            </div>
          </div>
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Por nivel de estratificacion</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartLevelBar" width="260" height="200"></canvas>
              <div class="chartLegend" id="legendLevel"></div>
            </div>
          </div>
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Por servicio / patologia</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartServiceBar" width="260" height="200"></canvas>
            </div>
          </div>
        </div>

        <!-- Row 3: Treatment + LDL trend -->
        <div class="grid grid2" style="margin-top:14px">
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Por tratamiento (farmaco hospitalario)</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartTreatBar" width="400" height="220"></canvas>
            </div>
          </div>
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Evolucion LDL media (todos los pacientes)</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartLDLTrend" width="400" height="220"></canvas>
            </div>
          </div>
        </div>

        <!-- Row 4: Intervention stats -->
        <div class="grid grid3" style="margin-top:14px">
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Intervenciones por tipo</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartIVType" width="260" height="200"></canvas>
              <div class="chartLegend" id="legendIVType"></div>
            </div>
          </div>
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Estado intervenciones</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartIVStatus" width="260" height="200"></canvas>
              <div class="chartLegend" id="legendIVStatus"></div>
            </div>
          </div>
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Adherencia al tratamiento</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartAdherence" width="260" height="200"></canvas>
              <div class="chartLegend" id="legendAdherence"></div>
            </div>
          </div>
        </div>

        <!-- Row 5: Response table -->
        <div class="panel" style="margin-top:14px">
          <div class="panelHeader">
            <div class="panelTitle">Respuesta al tratamiento (valoracion farmaceutica)</div>
          </div>
          <div class="tableWrap">
            <table class="table" id="dash_responseTable">
              <thead>
                <tr>
                  <th>Paciente</th>
                  <th>Patologia</th>
                  <th>Nivel</th>
                  <th>Farmaco</th>
                  <th>LDL ultimo</th>
                  <th>Objetivo</th>
                  <th>Respuesta</th>
                </tr>
              </thead>
              <tbody id="dash_responseBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="interventionsView" class="view hidden">
        <div class="dashRow">
          <div class="miniCard">
            <div class="miniLabel">Total intervenciones</div>
            <div class="miniValue" id="iv_total">0</div>
          </div>
          <div class="miniCard">
            <div class="miniLabel">Aceptadas</div>
            <div class="miniValue" id="iv_accepted" style="color:var(--accent2)">0</div>
          </div>
          <div class="miniCard">
            <div class="miniLabel">Pendientes</div>
            <div class="miniValue" id="iv_pending" style="color:var(--accent)">0</div>
          </div>
        </div>
        <div class="dashRow">
          <div class="miniCard">
            <div class="miniLabel">Rechazadas</div>
            <div class="miniValue" id="iv_rejected" style="color:var(--danger)">0</div>
          </div>
          <div class="miniCard">
            <div class="miniLabel">Tasa de aceptacion</div>
            <div class="miniValue" id="iv_rate">‚Äî</div>
          </div>
          <div class="miniCard">
            <div class="miniLabel">Pacientes con intervenciones</div>
            <div class="miniValue" id="iv_patients">0</div>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Por dimension CMO</div></div>
            <div class="cardBody" id="iv_byDimension"></div>
          </div>
          <div class="card span2">
            <div class="cardHeader"><div class="cardTitle">Por tipo de intervencion</div></div>
            <div class="cardBody" id="iv_byType"></div>
          </div>
        </div>

        <div class="panel" style="margin-top:14px">
          <div class="panelHeader">
            <div class="panelTitle">Listado de intervenciones</div>
            <div class="panelActions">
              <select id="ivFilterStatus" class="select" style="width:auto">
                <option value="">Todos los estados</option>
                <option value="accepted">Aceptadas</option>
                <option value="pending">Pendientes</option>
                <option value="rejected">Rechazadas</option>
              </select>
            </div>
          </div>
          <div class="tableWrap">
            <table class="table" id="iv_table">
              <thead>
                <tr>
                  <th>Paciente</th>
                  <th>Fecha visita</th>
                  <th>Dimension</th>
                  <th>Intervencion</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody id="iv_tbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id=‚ÄùexportsView‚Äù class=‚Äùview hidden‚Äù>
        <div class=‚Äùpanel‚Äù>
          <div class=‚ÄùpanelHeader‚Äù>
            <div>
              <div class=‚ÄùpanelTitle‚Äù>Exportaci√≥n e Importaci√≥n</div>
              <div class=‚ÄùsmallMuted‚Äù>CSV para Excel/investigaci√≥n (sep. <b>;</b>, UTF-8 BOM) ¬∑ Backup JSON para restauraci√≥n exacta.</div>
            </div>
          </div>

          <!-- ‚îÄ‚îÄ Bloque A: Exportar CSV ‚îÄ‚îÄ -->
          <div class=‚ÄùexBlock‚Äù>
            <div class=‚ÄùexBlockTitle‚Äù>‚¨á Exportar CSV (Excel Espa√±a)</div>
            <div class=‚ÄùsmallMuted‚Äù style=‚Äùmargin-bottom:12px‚Äù>
              Separador: <code class=‚ÄùinlineCode‚Äù>;</code> ¬∑ Codificaci√≥n: UTF-8 con BOM ¬∑ Abre directamente en Excel sin configuraci√≥n adicional.
            </div>
            <div class=‚Äùgrid grid3‚Äù>
              <div class=‚Äùcard‚Äù>
                <div class=‚ÄùcardHeader‚Äù><div class=‚ÄùcardTitle‚Äù>Pacientes</div></div>
                <div class=‚ÄùcardBody‚Äù>
                  <div class=‚ÄùsmallMuted‚Äù style=‚Äùmargin-bottom:10px‚Äù>
                    Columnas: <code class=‚ÄùinlineCode‚Äù>patientId</code>, <code class=‚ÄùinlineCode‚Äù>prevalentCondition</code>, sex, birthYear, comorbidities, notes, status‚Ä¶
                  </div>
                  <div class=‚ÄùbtnRow‚Äù>
                    <button class=‚Äùbtn‚Äù id=‚ÄùbtnExportPatientsCSV‚Äù>‚¨á patients.csv</button>
                    <button class=‚Äùbtn ghost‚Äù id=‚ÄùbtnTemplatePatients‚Äù>üìÑ Plantilla</button>
                  </div>
                </div>
              </div>
              <div class=‚Äùcard‚Äù>
                <div class=‚ÄùcardHeader‚Äù><div class=‚ÄùcardTitle‚Äù>Visitas</div></div>
                <div class=‚ÄùcardBody‚Äù>
                  <div class=‚ÄùsmallMuted‚Äù style=‚Äùmargin-bottom:10px‚Äù>
                    Columnas: <code class=‚ÄùinlineCode‚Äù>visitId</code>, <code class=‚ÄùinlineCode‚Äù>patientId</code>, date, ldl, ldlTarget, cmoScore, priorityLevel‚Ä¶
                  </div>
                  <div class=‚ÄùbtnRow‚Äù>
                    <button class=‚Äùbtn‚Äù id=‚ÄùbtnExportVisitsCSV‚Äù>‚¨á visits.csv</button>
                    <button class=‚Äùbtn ghost‚Äù id=‚ÄùbtnTemplateVisits‚Äù>üìÑ Plantilla</button>
                  </div>
                </div>
              </div>
              <div class=‚Äùcard‚Äù>
                <div class=‚ÄùcardHeader‚Äù><div class=‚ÄùcardTitle‚Äù>Intervenciones</div></div>
                <div class=‚ÄùcardBody‚Äù>
                  <div class=‚ÄùsmallMuted‚Äù style=‚Äùmargin-bottom:10px‚Äù>
                    Columnas: <code class=‚ÄùinlineCode‚Äù>interventionId</code>, <code class=‚ÄùinlineCode‚Äù>patientId</code>, visitId, cmoDimension, description, status‚Ä¶
                  </div>
                  <div class=‚ÄùbtnRow‚Äù>
                    <button class=‚Äùbtn‚Äù id=‚ÄùbtnExportInterventionsCSV‚Äù>‚¨á interventions.csv</button>
                    <button class=‚Äùbtn ghost‚Äù id=‚ÄùbtnTemplateInterventions‚Äù>üìÑ Plantilla</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class=‚Äùdivider‚Äù></div>

          <!-- ‚îÄ‚îÄ Bloque B: Importar CSV ‚îÄ‚îÄ -->
          <div class=‚ÄùexBlock‚Äù>
            <div class=‚ÄùexBlockTitle‚Äù>‚¨Ü Importar desde CSV</div>
            <div class=‚ÄùsmallMuted‚Äù style=‚Äùmargin-bottom:12px‚Äù>
              Valida todo antes de guardar (transaccional). Acepta separador <b>;</b> o <b>,</b> y BOM.
              Los registros con ID existente se <b>sobrescriben</b>. Para restauraci√≥n completa usa el Backup JSON.
            </div>
            <div class=‚Äùgrid grid3‚Äù>
              <div class=‚Äùcard‚Äù>
                <div class=‚ÄùcardHeader‚Äù><div class=‚ÄùcardTitle‚Äù>Pacientes CSV</div></div>
                <div class=‚ÄùcardBody‚Äù>
                  <div class=‚ÄùsmallMuted‚Äù style=‚Äùmargin-bottom:10px‚Äù>
                    Obligatorio: <code class=‚ÄùinlineCode‚Äù>patientId</code>, <code class=‚ÄùinlineCode‚Äù>prevalentCondition</code>
                  </div>
                  <label class=‚Äùbtn ghost fileBtn exImportBtn‚Äù>
                    ‚¨Ü Importar patients.csv
                    <input type=‚Äùfile‚Äù id=‚ÄùfileImportPatientsCSV‚Äù accept=‚Äù.csv,text/csv‚Äù />
                  </label>
                </div>
              </div>
              <div class=‚Äùcard‚Äù>
                <div class=‚ÄùcardHeader‚Äù><div class=‚ÄùcardTitle‚Äù>Visitas CSV</div></div>
                <div class=‚ÄùcardBody‚Äù>
                  <div class=‚ÄùsmallMuted‚Äù style=‚Äùmargin-bottom:10px‚Äù>
                    Obligatorio: <code class=‚ÄùinlineCode‚Äù>visitId</code>, <code class=‚ÄùinlineCode‚Äù>patientId</code>, <code class=‚ÄùinlineCode‚Äù>date</code>
                  </div>
                  <label class=‚Äùbtn ghost fileBtn exImportBtn‚Äù>
                    ‚¨Ü Importar visits.csv
                    <input type=‚Äùfile‚Äù id=‚ÄùfileImportVisitsCSV‚Äù accept=‚Äù.csv,text/csv‚Äù />
                  </label>
                </div>
              </div>
              <div class=‚Äùcard‚Äù>
                <div class=‚ÄùcardHeader‚Äù><div class=‚ÄùcardTitle‚Äù>Intervenciones CSV</div></div>
                <div class=‚ÄùcardBody‚Äù>
                  <div class=‚ÄùsmallMuted‚Äù style=‚Äùmargin-bottom:10px‚Äù>
                    Obligatorio: <code class=‚ÄùinlineCode‚Äù>interventionId</code>, <code class=‚ÄùinlineCode‚Äù>patientId</code>, <code class=‚ÄùinlineCode‚Äù>visitId</code>, <code class=‚ÄùinlineCode‚Äù>cmoDimension</code>, <code class=‚ÄùinlineCode‚Äù>description</code>, <code class=‚ÄùinlineCode‚Äù>status</code>
                  </div>
                  <label class=‚Äùbtn ghost fileBtn exImportBtn‚Äù>
                    ‚¨Ü Importar interventions.csv
                    <input type=‚Äùfile‚Äù id=‚ÄùfileImportInterventionsCSV‚Äù accept=‚Äù.csv,text/csv‚Äù />
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class=‚Äùdivider‚Äù></div>

          <!-- ‚îÄ‚îÄ Bloque C: Backup JSON ‚îÄ‚îÄ -->
          <div class=‚ÄùexBlock‚Äù>
            <div class=‚ÄùexBlockTitle‚Äù>üíæ Backup / Restauraci√≥n JSON</div>
            <div class=‚ÄùsmallMuted‚Äù style=‚Äùmargin-bottom:12px‚Äù>
              Copia completa del estado (pacientes + visitas + intervenciones). Recomendado para migraci√≥n exacta.<br>
              Recomendaci√≥n: backup semanal en ubicaci√≥n corporativa autorizada.
            </div>
            <div class=‚Äùgrid grid2‚Äù>
              <div class=‚Äùcard‚Äù>
                <div class=‚ÄùcardHeader‚Äù><div class=‚ÄùcardTitle‚Äù>Exportar backup</div></div>
                <div class=‚ÄùcardBody‚Äù>
                  <button class=‚Äùbtn‚Äù id=‚ÄùbtnBackupJSON‚Äù>‚¨á Exportar backup.json</button>
                  <div class=‚ÄùsmallMuted‚Äù style=‚Äùmargin-top:8px‚Äù>Incluye appName, versi√≥n y fecha de exportaci√≥n.</div>
                </div>
              </div>
              <div class=‚Äùcard‚Äù>
                <div class=‚ÄùcardHeader‚Äù><div class=‚ÄùcardTitle‚Äù>Restaurar backup</div></div>
                <div class=‚ÄùcardBody‚Äù>
                  <label class=‚Äùbtn ghost fileBtn exImportBtn‚Äù>
                    ‚¨Ü Importar backup.json
                    <input type=‚Äùfile‚Äù id=‚ÄùfileImportJSON‚Äù accept=‚Äùapplication/json‚Äù />
                  </label>
                  <div class=‚ÄùsmallMuted‚Äù style=‚Äùmargin-top:8px‚Äù>Valida appName y versi√≥n. Solicita confirmaci√≥n antes de sobrescribir.</div>
                </div>
              </div>
            </div>
          </div>

          <div class=‚Äùdivider‚Äù></div>

          <!-- ‚îÄ‚îÄ Bloque D: PDF ‚îÄ‚îÄ -->
          <div class=‚Äùcard‚Äù>
            <div class=‚ÄùcardHeader‚Äù><div class=‚ÄùcardTitle‚Äù>Informe PDF (por navegador)</div></div>
            <div class=‚ÄùcardBody‚Äù>
              <p class=‚ÄùsmallMuted‚Äù>Para PDF: abre la ficha del paciente y usa <b>Imprimir ‚Üí Guardar como PDF</b>.</p>
            </div>
          </div>

        </div>
      </section>

      <section id="aboutView" class="view hidden">
        <div class="panel">
          <div class="panelHeader">
            <div class="panelTitle">Ayuda rapida</div>
          </div>
          <div class="card">
            <div class="cardBody">
              <ul class="bullets">
                <li><b>Local-first:</b> los datos se guardan en este navegador (IndexedDB).</li>
                <li><b>RGPD:</b> usa <b>ID pseudonimizado</b>. No guardes nombre/NIH/telefono.</li>
                <li><b>Backup:</b> usa "Backup JSON" de forma periodica.</li>
                <li><b>Investigacion:</b> exporta CSV (patients/visits/interventions).</li>
                <li><b>Estratificacion:</b> variables por visita, precarga en sucesivas, score y nivel calculados con cortes fijos.</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="panel" style="margin-top:14px">
          <div class="panelHeader">
            <div class="panelTitle">Acerca de</div>
          </div>
          <div class="card">
            <div class="cardBody">
              <p style="margin:0 0 8px;font-weight:800;font-size:15px">Herramienta de seguimiento CMO para Riesgo Cardiovascular (RCV)</p>
              <p style="margin:0 0 6px;color:var(--muted);font-size:13px">Creado por <b style="color:var(--text)">Ramon Morillo</b> ‚Äî Febrero 2026</p>
            </div>
          </div>
        </div>

        <div class="panel" style="margin-top:14px">
          <div class="panelHeader">
            <div class="panelTitle">Aviso legal y condiciones de uso</div>
          </div>
          <div class="card">
            <div class="cardBody" style="font-size:12px;line-height:1.55;color:var(--muted)">
              <p style="margin:0 0 10px"><b style="color:var(--text)">1. Finalidad.</b> Esta herramienta ha sido disenada exclusivamente como apoyo al seguimiento farmacoterapeutico en consultas de atencion farmaceutica hospitalaria. No constituye un producto sanitario ni un sistema de informacion clinica oficial. Su uso es complementario y no sustituye al juicio clinico profesional ni a los sistemas de historia clinica electronica del centro.</p>
              <p style="margin:0 0 10px"><b style="color:var(--text)">2. Proteccion de datos y RGPD.</b> La herramienta funciona integramente en el navegador del usuario (arquitectura local-first). No se transmiten datos a servidores externos. El usuario es responsable de utilizar unicamente identificadores pseudonimizados y de no almacenar datos de caracter personal (nombre, NHC, telefono, etc.) conforme al Reglamento (UE) 2016/679 (RGPD) y la Ley Organica 3/2018 (LOPDGDD). El responsable del tratamiento de los datos sera, en todo caso, la institucion sanitaria correspondiente.</p>
              <p style="margin:0 0 10px"><b style="color:var(--text)">3. Sin garantia.</b> La herramienta se proporciona "tal cual" (AS IS), sin garantias de ningun tipo, expresas o implicitas. El autor no se responsabiliza de errores en los calculos de estratificacion, perdida de datos por fallo del navegador o del dispositivo, ni de decisiones clinicas basadas en la informacion mostrada.</p>
              <p style="margin:0 0 10px"><b style="color:var(--text)">4. Responsabilidad del usuario.</b> El usuario profesional sanitario es el unico responsable de: (a) verificar la exactitud de los datos introducidos; (b) realizar copias de seguridad periodicas; (c) cumplir la normativa de proteccion de datos de su institucion; (d) validar las recomendaciones y estratificaciones con las guias clinicas vigentes.</p>
              <p style="margin:0 0 10px"><b style="color:var(--text)">5. Propiedad intelectual.</b> Todos los derechos sobre el diseno, codigo y contenido de esta herramienta pertenecen al autor. Se permite su uso con fines asistenciales y de investigacion dentro del marco institucional. Queda prohibida su reproduccion, distribucion o modificacion sin autorizacion expresa del autor.</p>
              <p style="margin:0"><b style="color:var(--text)">6. Limitacion de responsabilidad.</b> En ningun caso el autor sera responsable de danos directos, indirectos, incidentales o consecuentes derivados del uso o la imposibilidad de uso de esta herramienta, incluyendo pero no limitado a la perdida de datos, interrupcion de la actividad asistencial o decisiones clinicas inadecuadas.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Modal: New Patient -->
      <div class="modal hidden" id="modalPatient">
        <div class="modalBackdrop" data-close="modalPatient"></div>
        <div class="modalCard modalWide">
          <div class="modalHeader">
            <div class="modalTitle">Nuevo paciente</div>
            <button class="iconBtn" data-close="modalPatient">‚úï</button>
          </div>
          <div class="modalBody">
            <div class="formGrid">
              <div class="field">
                <label>ID pseud√≥nimo *</label>
                <input class="input" id="p_patientId" placeholder="Ej. PCSK9-000123" />
                <div class="hint">No usar nombre/NIH.</div>
              </div>

              <div class="field">
                <label>Patolog√≠a prevalente *</label>
                <select class="select" id="p_condition"></select>
              </div>

              <div class="field">
                <label>Sexo</label>
                <select class="select" id="p_sex">
                  <option value="">‚Äî</option>
                  <option value="M">M</option>
                  <option value="F">F</option>
                  <option value="X">X</option>
                </select>
              </div>

              <div class="field">
                <label>A√±o de nacimiento</label>
                <input class="input" id="p_birthYear" inputmode="numeric" placeholder="Ej. 1972" />
              </div>

              <div class="field span2">
                <label>Comorbilidades (coma)</label>
                <input class="input" id="p_comorb" placeholder="Ej. DM2, ERC, ECV previa..." />
              </div>

              <div class="field span2">
                <label>Notas</label>
                <textarea class="textarea" id="p_notes" rows="3" placeholder="Barreras estables, contexto social, etc."></textarea>
              </div>

              <div class="field">
                <label>Estado</label>
                <select class="select" id="p_status">
                  <option value="active">Activo</option>
                  <option value="inactive">Inactivo</option>
                </select>
              </div>

              <div class="field">
                <label>Score estratificaci√≥n</label>
                <input class="input" id="p_score" readonly />
              </div>

              <div class="field">
                <label>Nivel/Prioridad (auto)</label>
                <input class="input" id="p_levelAuto" readonly />
              </div>

              <div class="field span2">
                <label>Estratificaci√≥n CMO ‚Äî variables basales</label>
                <div class="interventionsWrap" id="stratVarsPicker"></div>
                <div class="smallMuted">El score y nivel se recalculan al cambiar cualquier variable.</div>
              </div>
            </div>
          </div>
          <div class="modalFooter">
            <button class="btn ghost" data-close="modalPatient">Cancelar</button>
            <button class="btn" id="btnSavePatient">Guardar</button>
          </div>
        </div>
      </div>

      <!-- Modal: New Visit -->
      <div class="modal hidden" id="modalVisit">
        <div class="modalBackdrop" data-close="modalVisit"></div>
        <div class="modalCard modalWide">
          <div class="modalHeader">
            <div class="modalTitle">Nueva visita</div>
            <button class="iconBtn" data-close="modalVisit">‚úï</button>
          </div>
          <div class="modalBody">
            <div class="smallMuted" id="visitForPatient">‚Äî</div>

            <div class="formGrid">
              <div class="field">
                <label>Fecha *</label>
                <input class="input" id="v_date" type="date" />
              </div>

              <div class="field">
                <label>F√°rmaco hospitalario</label>
                <select class="select" id="v_hospDrug"></select>
              </div>

              <div class="field">
                <label>LDL (mg/dL)</label>
                <input class="input" id="v_ldl" inputmode="decimal" placeholder="Ej. 55" />
              </div>

              <div class="field">
                <label>Objetivo LDL (mg/dL)</label>
                <input class="input" id="v_ldlTarget" inputmode="decimal" placeholder="Ej. 55" />
              </div>

              <div class="field">
                <label>¬øObjetivo alcanzado?</label>
                <select class="select" id="v_goalAch">
                  <option value="">‚Äî</option>
                  <option value="true">S√≠</option>
                  <option value="false">No</option>
                </select>
              </div>

              <div class="field span2">
                <label>Tratamiento (texto libre)</label>
                <input class="input" id="v_treatment" placeholder="Ej. PCSK9 + estatina + ezetimiba..." />
              </div>

              <div class="field">
                <label>Adherencia</label>
                <input class="input" id="v_adherence" placeholder="Ej. Buena / irregular / 80%..." />
              </div>

              <div class="field">
                <label>RAM</label>
                <input class="input" id="v_ram" placeholder="Ej. reacci√≥n local, mialgias..." />
              </div>

              <div class="field span2">
                <label>Justificaci√≥n nivel (breve)</label>
                <input class="input" id="v_levelWhy" placeholder="Ej. No objetivo + cambios + baja adherencia..." />
              </div>

              <div class="field span2">
                <label>Objetivos farmacoterap√©uticos (OFT)</label>
                <textarea class="textarea" id="v_oft" rows="2"></textarea>
              </div>

              <div class="field span2">
                <label>Plan de seguimiento</label>
                <textarea class="textarea" id="v_follow" rows="2"></textarea>
              </div>

              <div class="field span2">
                <label>Intervenciones CMO (selecciona y define estado)</label>
                <div class="interventionsWrap" id="interventionsPicker"></div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="sectionTitle">Texto para HC (copy-paste)</div>
            <textarea class="textarea mono" id="v_hcText" rows="7" readonly></textarea>
            <div class="btnRow">
              <button class="btn ghost" id="btnGenerateHC">Generar texto HC</button>
              <button class="btn ghost" id="btnCopyHC">Copiar</button>
            </div>
          </div>

          <div class="modalFooter">
            <button class="btn ghost" data-close="modalVisit">Cancelar</button>
            <button class="btn" id="btnSaveVisit">Guardar visita</button>
          </div>
        </div>
      </div>

      <!-- Modal: Visit details -->
      <div class="modal hidden" id="modalVisitDetail">
        <div class="modalBackdrop" data-close="modalVisitDetail"></div>
        <div class="modalCard modalWide">
          <div class="modalHeader">
            <div class="modalTitle">Detalle visita</div>
            <button class="iconBtn" data-close="modalVisitDetail">‚úï</button>
          </div>
          <div class="modalBody">
            <div class="smallMuted" id="vd_header">‚Äî</div>
            <div class="divider"></div>
            <div class="kv" id="vd_kv"></div>
            <div class="divider"></div>
            <div class="sectionTitle">Intervenciones</div>
            <div id="vd_interventions" class="chips"></div>
          </div>
          <div class="modalFooter">
            <button class="btn ghost" data-close="modalVisitDetail">Cerrar</button>
            <button class="btn danger" id="btnDeleteVisit">Eliminar visita</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Mobile floating button (visible when sidebar is hidden) -->
  <button class="authBtnMobile" id="btnAuthorshipMobile" aria-label="Autor√≠a y uso" aria-haspopup="dialog">‚Ñπ</button>

  <!-- Modal: Autor√≠a y uso -->
  <div class="modal hidden" id="modalAuthorship" role="dialog" aria-modal="true" aria-labelledby="modalAuthorshipTitle">
    <div class="modalBackdrop"></div>
    <div class="modalCard amModal">
      <div class="modalHeader">
        <div class="modalTitle" id="modalAuthorshipTitle">CMO RCV ‚Äî Autor√≠a y uso</div>
        <button class="iconBtn" id="btnCloseAuthorship" aria-label="Cerrar modal">‚úï</button>
      </div>

      <div class="modalBody amBody">
        <div class="amIntro">
          <div class="amIntroTitle">CMO RCV</div>
          <div class="amIntroSub">Creado por Ram√≥n Morillo &nbsp;¬∑&nbsp; Febrero 2026 &nbsp;¬∑&nbsp; Versi√≥n <span class="amVersionSpan"></span></div>
        </div>

        <!-- A) Autor√≠a -->
        <div class="amSection">
          <div class="amSectionTitle">A) Autor√≠a</div>
          <p class="amText"><strong>Desarrollado por:</strong> Ram√≥n Morillo</p>
          <p class="amText"><strong>Asistencia t√©cnica:</strong> Desarrollo asistido mediante herramientas de inteligencia artificial (Claude Code / Large Language Models).</p>
        </div>

        <!-- B) Base metodol√≥gica -->
        <div class="amSection">
          <div class="amSectionTitle">B) Base metodol√≥gica</div>
          <p class="amText">CMO RCV se fundamenta en principios y marcos de referencia habituales en:</p>
          <ul class="amList">
            <li>Estratificaci√≥n y evaluaci√≥n del riesgo cardiovascular (enfoque cl√≠nico y de factores de riesgo).</li>
            <li>Atenci√≥n farmac√©utica basada en el modelo CMO (Capacidad‚ÄìMotivaci√≥n‚ÄìOportunidad) aplicado a priorizaci√≥n y seguimiento.</li>
            <li>Revisi√≥n estructurada de informaci√≥n cl√≠nica/autoinformada para apoyo a decisiones.</li>
            <li>Conceptos metodol√≥gicos relacionados con:
              <ul>
                <li>Validez y coherencia interna de la informaci√≥n</li>
                <li>Priorizaci√≥n asistencial</li>
                <li>Enfoque centrado en la persona</li>
                <li>Seguridad y adecuaci√≥n farmacoterap√©utica (cuando aplique)</li>
              </ul>
            </li>
          </ul>
        </div>

        <!-- C) Declaraci√≥n de independencia -->
        <div class="amSection">
          <div class="amSectionTitle">C) Declaraci√≥n de independencia</div>
          <p class="amText">CMO RCV es una herramienta independiente. No est√° afiliada, respaldada ni certificada oficialmente por:</p>
          <ul class="amList">
            <li>Administraciones sanitarias</li>
            <li>Sociedades cient√≠ficas</li>
            <li>Agencias reguladoras</li>
            <li>Instituciones sanitarias</li>
          </ul>
        </div>

        <!-- D) Uso previsto y limitaciones -->
        <div class="amSection">
          <div class="amSectionTitle">D) Uso previsto y limitaciones</div>
          <div class="amWarning">
            CMO RCV <strong>NO</strong> sustituye el juicio cl√≠nico ni la valoraci√≥n profesional.<br>
            CMO RCV <strong>NO</strong> constituye una gu√≠a de pr√°ctica cl√≠nica ni una recomendaci√≥n terap√©utica directa.<br>
            Funciona como herramienta de apoyo orientativa para estratificar/priorizar y organizar el seguimiento.
          </div>
          <p class="amText" style="margin-top:10px">Los resultados:</p>
          <ul class="amList">
            <li>Dependen de la informaci√≥n introducida.</li>
            <li>Requieren interpretaci√≥n profesional.</li>
            <li>No garantizan conformidad con gu√≠as, normativas o protocolos locales.</li>
          </ul>
        </div>

        <!-- E) Derechos y licencia -->
        <div class="amSection">
          <div class="amSectionTitle">E) Derechos y licencia</div>
          <p class="amText">¬© 2026 Ram√≥n Morillo. Todos los derechos reservados.</p>
          <p class="amText">Queda prohibida la reproducci√≥n, redistribuci√≥n o modificaci√≥n total o parcial sin autorizaci√≥n expresa del autor.</p>
        </div>

        <!-- F) C√≥mo citar -->
        <div class="amSection">
          <div class="amSectionTitle">F) C√≥mo citar esta herramienta</div>
          <p class="amText"><strong>APA (7.¬™ edici√≥n)</strong></p>
          <div class="amMono">Morillo, R. (2026). <em>CMO RCV</em> (Versi√≥n <span class="amVersionSpan"></span>) [Software]. Disponible en: https://ramonmorillo.github.io/cmorcv/</div>
          <p class="amText" style="margin-top:10px"><strong>Vancouver</strong></p>
          <div class="amMono">Morillo R. CMO RCV. Version <span class="amVersionSpan"></span> [software]. 2026. Disponible en: https://ramonmorillo.github.io/cmorcv/</div>
        </div>

        <!-- G) Contacto -->
        <div class="amSection">
          <div class="amSectionTitle">G) Contacto</div>
          <p class="amText">Para incidencias, sugerencias o colaboraci√≥n acad√©mica:</p>
          <p class="amText">‚úâ <a href="mailto:ralejandro.morillo.sspa@juntadeandalucia.es" class="amLink">ralejandro.morillo.sspa@juntadeandalucia.es</a></p>
        </div>
      </div>

      <div class="modalFooter">
        <button class="btn ghost" id="btnCloseAuthorshipFooter">Cerrar</button>
      </div>
    </div>
  </div>

  <script src="./app.js"></script>
</body>
</html>
