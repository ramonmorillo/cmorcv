<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CMO Registry ‚Äî Consultas Externas</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">CMO</div>
        <div class="brandText">
          <div class="brandTitle">CMO Registry</div>
          <div class="brandSub">Consultas externas ¬∑ Local-first</div>
        </div>
      </div>

      <nav class="nav">
        <button class="navBtn active" data-view="patientsView">
          <span class="navIcon">üë•</span><span>Pacientes</span>
        </button>
        <button class="navBtn" data-view="exportsView">
          <span class="navIcon">üì§</span><span>Exportaci√≥n</span>
        </button>
        <button class="navBtn" data-view="aboutView">
          <span class="navIcon">üß©</span><span>Ayuda</span>
        </button>
      </nav>

      <div class="sidebarFooter">
        <div class="smallMuted">Datos guardados localmente (IndexedDB).</div>
        <div class="smallMuted">Recomendado: backup peri√≥dico.</div>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topbarLeft">
          <div class="pageTitle" id="pageTitle">Pacientes</div>
          <div class="pageHint" id="pageHint">Registro longitudinal con CMO + exportaci√≥n para investigaci√≥n</div>
        </div>

        <div class="topbarRight">
          <button class="btn ghost" id="btnQuickBackup" title="Backup JSON (recomendado)">
            ‚¨áÔ∏è Backup
          </button>
          <button class="btn" id="btnNewPatient">+ Nuevo paciente</button>
        </div>
      </header>

      <div id="toast" class="toast hidden"></div>

      <section id="patientsView" class="view">
        <div class="panel">
          <div class="panelHeader">
            <div class="panelTitle">Listado</div>
            <div class="panelActions">
              <input id="patientSearch" class="input" placeholder="Buscar por ID, patolog√≠a, notas..." />
              <select id="conditionFilter" class="select">
                <option value="">Todas las patolog√≠as</option>
              </select>
            </div>
          </div>

          <div class="grid">
            <div class="card">
              <div class="cardHeader">
                <div class="cardTitle">Pacientes</div>
                <div class="badge" id="patientsCount">0</div>
              </div>
              <div class="cardBody">
                <div class="statRow">
                  <div class="stat">
                    <div class="statLabel">Activos</div>
                    <div class="statValue" id="statActive">0</div>
                  </div>
                  <div class="stat">
                    <div class="statLabel">Con ‚â•1 visita</div>
                    <div class="statValue" id="statWithVisits">0</div>
                  </div>
                  <div class="stat">
                    <div class="statLabel">√öltimo backup</div>
                    <div class="statValue small" id="statLastBackup">‚Äî</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card span2">
              <div class="cardHeader">
                <div class="cardTitle">Tabla</div>
                <div class="smallMuted">Click en un paciente para abrir ficha</div>
              </div>
              <div class="cardBody">
                <div class="tableWrap">
                  <table class="table" id="patientsTable">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Patolog√≠a</th>
                        <th>Sexo</th>
                        <th>Nac.</th>
                        <th>√öltima visita</th>
                        <th>Nivel</th>
                        <th>Score</th>
                        <th>LDL √∫ltimo</th>
                        <th>Objetivo</th>
                        <th>Estado</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid">
            <div class="card span3 hidden" id="patientDetailCard">
              <div class="cardHeader">
                <div class="cardTitle" id="patientDetailTitle">Ficha</div>
                <div class="cardActions">
                  <button class="btn ghost" id="btnBackToList">‚Üê Volver</button>
                  <button class="btn" id="btnNewVisit">+ Nueva visita</button>
                  <button class="btn danger" id="btnDeletePatient">Eliminar paciente</button>
                </div>
              </div>

              <div class="cardBody">
                <div class="detailGrid">
                  <div class="detailSection">
                    <div class="sectionTitle">Resumen</div>
                    <div class="kv">
                      <div class="k">ID</div><div class="v" id="d_patientId">‚Äî</div>
                      <div class="k">Patolog√≠a</div><div class="v" id="d_condition">‚Äî</div>
                      <div class="k">Sexo</div><div class="v" id="d_sex">‚Äî</div>
                      <div class="k">A√±o nac.</div><div class="v" id="d_birthYear">‚Äî</div>
                      <div class="k">Comorbilidades</div><div class="v" id="d_comorb">‚Äî</div>
                      <div class="k">Notas</div><div class="v" id="d_notes">‚Äî</div>
                    </div>
                  </div>

                  <div class="detailSection">
                    <div class="sectionTitle">Dashboard</div>
                    <div class="dashRow">
                      <div class="miniCard">
                        <div class="miniLabel">Nivel actual</div>
                        <div class="miniValue" id="d_levelNow">‚Äî</div>
                        <div class="miniHint" id="d_levelWhy">‚Äî</div>
                      </div>
                      <div class="miniCard">
                        <div class="miniLabel">Score actual</div>
                        <div class="miniValue" id="d_scoreNow">‚Äî</div>
                        <div class="miniHint">Cortes: ‚â•23‚ÜíN1; ‚â•17‚ÜíN2</div>
                      </div>
                      <div class="miniCard">
                        <div class="miniLabel">LDL √∫ltimo</div>
                        <div class="miniValue" id="d_ldlLast">‚Äî</div>
                        <div class="miniHint" id="d_ldlGoal">‚Äî</div>
                      </div>
                    </div>

                    <div class="chartWrap">
                      <canvas id="ldlChart" width="900" height="240"></canvas>
                      <div class="smallMuted">Evoluci√≥n LDL (mg/dL). (Gr√°fico local, sin librer√≠as externas).</div>
                    </div>
                  </div>
                </div>

                <div class="divider"></div>

                <div class="sectionTitle">Visitas</div>
                <div class="tableWrap">
                  <table class="table" id="visitsTable">
                    <thead>
                      <tr>
                        <th>Fecha</th>
                        <th>F√°rmaco hospitalario</th>
                        <th>LDL</th>
                        <th>Objetivo</th>
                        <th>¬øCumple?</th>
                        <th>Score</th>
                        <th>Nivel</th>
                        <th>Tratamiento (texto)</th>
                        <th>Adherencia</th>
                        <th>RAM</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <section id="exportsView" class="view hidden">
        <div class="panel">
          <div class="panelHeader">
            <div>
              <div class="panelTitle">Exportaci√≥n y copias de seguridad</div>
              <div class="smallMuted">
                CSV para Excel (investigaci√≥n) + Backup JSON completo (migraci√≥n/restauraci√≥n).
              </div>
            </div>
          </div>

          <div class="grid">
            <div class="card">
              <div class="cardHeader">
                <div class="cardTitle">CSV (Excel)</div>
              </div>
              <div class="cardBody">
                <div class="btnRow">
                  <button class="btn" id="btnExportPatientsCSV">Export patients.csv</button>
                  <button class="btn" id="btnExportVisitsCSV">Export visits.csv</button>
                  <button class="btn" id="btnExportInterventionsCSV">Export interventions.csv</button>
                </div>
                <div class="smallMuted">
                  Formato longitudinal (visitas e intervenciones normalizadas).
                </div>
              </div>
            </div>

            <div class="card">
              <div class="cardHeader">
                <div class="cardTitle">Backup JSON</div>
              </div>
              <div class="cardBody">
                <div class="btnRow">
                  <button class="btn" id="btnBackupJSON">‚¨áÔ∏è Export backup.json</button>
                  <label class="btn ghost fileBtn">
                    ‚¨ÜÔ∏è Importar backup.json
                    <input type="file" id="fileImportJSON" accept="application/json" />
                  </label>
                </div>
                <div class="smallMuted">
                  Recomendaci√≥n: backup semanal en ubicaci√≥n corporativa autorizada.
                </div>
              </div>
            </div>

            <div class="card span2">
              <div class="cardHeader">
                <div class="cardTitle">Informe PDF (por navegador)</div>
              </div>
              <div class="cardBody">
                <p class="smallMuted">
                  Para PDF: abre la ficha del paciente y usa <b>Imprimir</b> ‚Üí ‚ÄúGuardar como PDF‚Äù.
                </p>
              </div>
            </div>
          </div>

        </div>
      </section>

      <section id="aboutView" class="view hidden">
        <div class="panel">
          <div class="panelHeader">
            <div class="panelTitle">Ayuda r√°pida</div>
          </div>
          <div class="card">
            <div class="cardBody">
              <ul class="bullets">
                <li><b>Local-first:</b> los datos se guardan en este navegador (IndexedDB).</li>
                <li><b>RGPD:</b> usa <b>ID pseudonimizado</b>. No guardes nombre/NIH/telefono.</li>
                <li><b>Backup:</b> usa ‚ÄúBackup JSON‚Äù de forma peri√≥dica.</li>
                <li><b>Investigaci√≥n:</b> exporta CSV (patients/visits/interventions).</li>
                <li><b>Estratificaci√≥n:</b> variables por visita, precarga en sucesivas, score y nivel calculados con cortes fijos.</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- Modal: New Patient -->
      <div class="modal hidden" id="modalPatient">
        <div class="modalBackdrop" data-close="modalPatient"></div>
        <div class="modalCard">
          <div class="modalHeader">
            <div class="modalTitle">Nuevo paciente</div>
            <button class="iconBtn" data-close="modalPatient">‚úï</button>
          </div>
          <div class="modalBody">
            <div class="formGrid">
              <div class="field">
                <label>ID pseud√≥nimo *</label>
                <input class="input" id="p_patientId" placeholder="Ej. PCSK9-000123" />
                <div class="hint">No usar nombre/NIH.</div>
              </div>

              <div class="field">
                <label>Patolog√≠a prevalente *</label>
                <select class="select" id="p_condition"></select>
              </div>

              <div class="field">
                <label>Sexo</label>
                <select class="select" id="p_sex">
                  <option value="">‚Äî</option>
                  <option value="M">M</option>
                  <option value="F">F</option>
                  <option value="X">X</option>
                </select>
              </div>

              <div class="field">
                <label>A√±o de nacimiento</label>
                <input class="input" id="p_birthYear" inputmode="numeric" placeholder="Ej. 1972" />
              </div>

              <div class="field span2">
                <label>Comorbilidades (coma)</label>
                <input class="input" id="p_comorb" placeholder="Ej. DM2, ERC, ECV previa..." />
              </div>

              <div class="field span2">
                <label>Notas</label>
                <textarea class="textarea" id="p_notes" rows="3" placeholder="Barreras estables, contexto social, etc."></textarea>
              </div>

              <div class="field">
                <label>Estado</label>
                <select class="select" id="p_status">
                  <option value="active">Activo</option>
                  <option value="inactive">Inactivo</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modalFooter">
            <button class="btn ghost" data-close="modalPatient">Cancelar</button>
            <button class="btn" id="btnSavePatient">Guardar</button>
          </div>
        </div>
      </div>

      <!-- Modal: New Visit -->
      <div class="modal hidden" id="modalVisit">
        <div class="modalBackdrop" data-close="modalVisit"></div>
        <div class="modalCard modalWide">
          <div class="modalHeader">
            <div class="modalTitle">Nueva visita</div>
            <button class="iconBtn" data-close="modalVisit">‚úï</button>
          </div>
          <div class="modalBody">
            <div class="smallMuted" id="visitForPatient">‚Äî</div>

            <div class="formGrid">
              <div class="field">
                <label>Fecha *</label>
                <input class="input" id="v_date" type="date" />
              </div>

              <div class="field">
                <label>F√°rmaco hospitalario</label>
                <select class="select" id="v_hospDrug"></select>
              </div>

              <div class="field">
                <label>LDL (mg/dL)</label>
                <input class="input" id="v_ldl" inputmode="decimal" placeholder="Ej. 55" />
              </div>

              <div class="field">
                <label>Objetivo LDL (mg/dL)</label>
                <input class="input" id="v_ldlTarget" inputmode="decimal" placeholder="Ej. 55" />
              </div>

              <div class="field">
                <label>¬øObjetivo alcanzado?</label>
                <select class="select" id="v_goalAch">
                  <option value="">‚Äî</option>
                  <option value="true">S√≠</option>
                  <option value="false">No</option>
                </select>
              </div>

              <div class="field span2">
                <label>Tratamiento (texto libre)</label>
                <input class="input" id="v_treatment" placeholder="Ej. PCSK9 + estatina + ezetimiba..." />
              </div>

              <div class="field">
                <label>Adherencia</label>
                <input class="input" id="v_adherence" placeholder="Ej. Buena / irregular / 80%..." />
              </div>

              <div class="field">
                <label>RAM</label>
                <input class="input" id="v_ram" placeholder="Ej. reacci√≥n local, mialgias..." />
              </div>

              <div class="field">
                <label>Score estratificaci√≥n</label>
                <input class="input" id="v_score" readonly />
              </div>

              <div class="field">
                <label>Nivel/Prioridad (auto)</label>
                <input class="input" id="v_levelAuto" readonly />
              </div>

              <div class="field span2">
                <label>Justificaci√≥n nivel (breve)</label>
                <input class="input" id="v_levelWhy" placeholder="Ej. No objetivo + cambios + baja adherencia..." />
              </div>

              <div class="field span2">
                <label>Objetivos farmacoterap√©uticos (OFT)</label>
                <textarea class="textarea" id="v_oft" rows="2"></textarea>
              </div>

              <div class="field span2">
                <label>Plan de seguimiento</label>
                <textarea class="textarea" id="v_follow" rows="2"></textarea>
              </div>

              <div class="field span2">
                <label>Estratificaci√≥n (tabla) ‚Äî variables por visita (precargadas de la previa)</label>
                <div class="interventionsWrap" id="stratVarsPicker"></div>
                <div class="smallMuted">El score y nivel se recalculan al cambiar cualquier variable.</div>
              </div>

              <div class="field span2">
                <label>Intervenciones CMO (selecciona y define estado)</label>
                <div class="interventionsWrap" id="interventionsPicker"></div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="sectionTitle">Texto para HC (copy-paste)</div>
            <textarea class="textarea mono" id="v_hcText" rows="7" readonly></textarea>
            <div class="btnRow">
              <button class="btn ghost" id="btnGenerateHC">Generar texto HC</button>
              <button class="btn ghost" id="btnCopyHC">Copiar</button>
            </div>
          </div>

          <div class="modalFooter">
            <button class="btn ghost" data-close="modalVisit">Cancelar</button>
            <button class="btn" id="btnSaveVisit">Guardar visita</button>
          </div>
        </div>
      </div>

      <!-- Modal: Visit details -->
      <div class="modal hidden" id="modalVisitDetail">
        <div class="modalBackdrop" data-close="modalVisitDetail"></div>
        <div class="modalCard modalWide">
          <div class="modalHeader">
            <div class="modalTitle">Detalle visita</div>
            <button class="iconBtn" data-close="modalVisitDetail">‚úï</button>
          </div>
          <div class="modalBody">
            <div class="smallMuted" id="vd_header">‚Äî</div>
            <div class="divider"></div>
            <div class="kv" id="vd_kv"></div>
            <div class="divider"></div>
            <div class="sectionTitle">Intervenciones</div>
            <div id="vd_interventions" class="chips"></div>
          </div>
          <div class="modalFooter">
            <button class="btn ghost" data-close="modalVisitDetail">Cerrar</button>
            <button class="btn danger" id="btnDeleteVisit">Eliminar visita</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script src="./app.js"></script>
</body>
</html>
