<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Herramienta seguimiento CMO para RCV</title>
  <link rel="stylesheet" href="./styles.css?v=20260225_1000" />
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">CMO</div>
        <div class="brandText">
          <div class="brandTitle">Seguimiento CMO</div>
          <div class="brandSub">Riesgo Cardiovascular ¬∑ Local-first</div>
        </div>
      </div>

      <nav class="nav">
        <button class="navBtn active" data-view="patientsView">
          <span class="navIcon">üë•</span><span>Pacientes</span>
        </button>
        <button class="navBtn" data-view="dashboardView">
          <span class="navIcon">üìä</span><span>Dashboard</span>
        </button>
        <button class="navBtn" data-view="interventionsView">
          <span class="navIcon">üíä</span><span>Intervenciones</span>
        </button>
        <button class="navBtn" data-view="exportsView">
          <span class="navIcon">üì§</span><span>Exportaci√≥n</span>
        </button>
        <button class="navBtn" data-view="aboutView">
          <span class="navIcon">üß©</span><span>Ayuda</span>
        </button>
      </nav>

      <div class="sidebarFooter">
        <div class="smallMuted" style="font-weight:700;color:var(--text)">Creado por Ramon Morillo</div>
        <div class="smallMuted">Febrero 2026</div>
        <div class="smallMuted" style="margin-top:6px">Datos guardados localmente (IndexedDB). Backup periodico recomendado.</div>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topbarLeft">
          <div class="pageTitle" id="pageTitle">Pacientes</div>
          <div class="pageHint" id="pageHint">Registro longitudinal con CMO + exportaci√≥n para investigaci√≥n</div>
        </div>

        <div class="topbarRight">
          <button class="btn ghost" id="btnQuickBackup" title="Backup JSON (recomendado)">
            ‚¨áÔ∏è Backup
          </button>
          <button class="btn" id="btnNewPatient">+ Nuevo paciente</button>
        </div>
      </header>

      <div id="toast" class="toast hidden"></div>

      <section id="patientsView" class="view">
        <div class="panel">
          <div class="panelHeader">
            <div class="panelTitle">Listado</div>
            <div class="panelActions">
              <input id="patientSearch" class="input" placeholder="Buscar por ID, patolog√≠a, notas..." />
              <select id="conditionFilter" class="select">
                <option value="">Todas las patolog√≠as</option>
              </select>
            </div>
          </div>

          <div class="grid">
            <div class="card">
              <div class="cardHeader">
                <div class="cardTitle">Pacientes</div>
                <div class="badge" id="patientsCount">0</div>
              </div>
              <div class="cardBody">
                <div class="statRow">
                  <div class="stat">
                    <div class="statLabel">Activos</div>
                    <div class="statValue" id="statActive">0</div>
                  </div>
                  <div class="stat">
                    <div class="statLabel">Con ‚â•1 visita</div>
                    <div class="statValue" id="statWithVisits">0</div>
                  </div>
                  <div class="stat">
                    <div class="statLabel">√öltimo backup</div>
                    <div class="statValue small" id="statLastBackup">‚Äî</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card span2">
              <div class="cardHeader">
                <div class="cardTitle">Tabla</div>
                <div class="smallMuted">Click en un paciente para abrir ficha</div>
              </div>
              <div class="cardBody">
                <div class="tableWrap">
                  <table class="table" id="patientsTable">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Patolog√≠a</th>
                        <th>Sexo</th>
                        <th>Nac.</th>
                        <th>√öltima visita</th>
                        <th>Nivel</th>
                        <th>Score</th>
                        <th>LDL √∫ltimo</th>
                        <th>Objetivo</th>
                        <th>Estado</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid">
            <div class="card span3 hidden" id="patientDetailCard">
              <div class="cardHeader">
                <div class="cardTitle" id="patientDetailTitle">Ficha</div>
                <div class="cardActions">
                  <button class="btn ghost" id="btnBackToList">‚Üê Volver</button>
                  <button class="btn" id="btnNewVisit">+ Nueva visita</button>
                  <button class="btn danger" id="btnDeletePatient">Eliminar paciente</button>
                </div>
              </div>

              <div class="cardBody">
                <div class="detailGrid">
                  <div class="detailSection">
                    <div class="sectionTitle">Resumen</div>
                    <div class="kv">
                      <div class="k">ID</div><div class="v" id="d_patientId">‚Äî</div>
                      <div class="k">Patolog√≠a</div><div class="v" id="d_condition">‚Äî</div>
                      <div class="k">Sexo</div><div class="v" id="d_sex">‚Äî</div>
                      <div class="k">A√±o nac.</div><div class="v" id="d_birthYear">‚Äî</div>
                      <div class="k">Comorbilidades</div><div class="v" id="d_comorb">‚Äî</div>
                      <div class="k">Notas</div><div class="v" id="d_notes">‚Äî</div>
                    </div>
                  </div>

                  <div class="detailSection">
                    <div class="sectionTitle">Dashboard</div>
                    <div class="dashRow">
                      <div class="miniCard">
                        <div class="miniLabel">Nivel actual</div>
                        <div class="miniValue" id="d_levelNow">‚Äî</div>
                        <div class="miniHint" id="d_levelWhy">‚Äî</div>
                      </div>
                      <div class="miniCard">
                        <div class="miniLabel">Score actual</div>
                        <div class="miniValue" id="d_scoreNow">‚Äî</div>
                        <div class="miniHint">Cortes: ‚â•23‚ÜíN1; ‚â•17‚ÜíN2</div>
                      </div>
                      <div class="miniCard">
                        <div class="miniLabel">LDL √∫ltimo</div>
                        <div class="miniValue" id="d_ldlLast">‚Äî</div>
                        <div class="miniHint" id="d_ldlGoal">‚Äî</div>
                      </div>
                    </div>

                    <div class="chartWrap">
                      <canvas id="ldlChart" width="900" height="240"></canvas>
                      <div class="smallMuted">Evoluci√≥n LDL (mg/dL). (Gr√°fico local, sin librer√≠as externas).</div>
                    </div>
                  </div>
                </div>

                <div class="divider"></div>

                <div class="sectionTitle">Visitas</div>
                <div class="tableWrap">
                  <table class="table" id="visitsTable">
                    <thead>
                      <tr>
                        <th>Fecha</th>
                        <th>F√°rmaco hospitalario</th>
                        <th>LDL</th>
                        <th>Objetivo</th>
                        <th>¬øCumple?</th>
                        <th>Score</th>
                        <th>Nivel</th>
                        <th>Tratamiento (texto)</th>
                        <th>Adherencia</th>
                        <th>RAM</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <section id="dashboardView" class="view hidden">
        <!-- Row 1: Summary cards -->
        <div class="dashRow dashRow4">
          <div class="miniCard miniCard--accent">
            <div class="miniLabel">En seguimiento activo</div>
            <div class="miniValue" id="dash_active">0</div>
            <div class="miniHint" id="dash_activePct"></div>
          </div>
          <div class="miniCard miniCard--green">
            <div class="miniLabel">Con visitas registradas</div>
            <div class="miniValue" id="dash_withVisits">0</div>
            <div class="miniHint" id="dash_withVisitsPct"></div>
          </div>
          <div class="miniCard miniCard--teal">
            <div class="miniLabel">Objetivo LDL alcanzado</div>
            <div class="miniValue" id="dash_goalYes">0</div>
            <div class="miniHint" id="dash_goalYesPct"></div>
          </div>
          <div class="miniCard miniCard--orange">
            <div class="miniLabel">Intervenciones pendientes</div>
            <div class="miniValue" id="dash_pendingIV">0</div>
            <div class="miniHint" id="dash_pendingIVHint"></div>
          </div>
        </div>

        <!-- Row 2: Visual charts -->
        <div class="grid grid3">
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Objetivo LDL</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartGoalDonut" width="260" height="200"></canvas>
              <div class="chartLegend" id="legendGoal"></div>
            </div>
          </div>
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Por nivel de estratificacion</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartLevelBar" width="260" height="200"></canvas>
              <div class="chartLegend" id="legendLevel"></div>
            </div>
          </div>
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Por servicio / patologia</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartServiceBar" width="260" height="200"></canvas>
            </div>
          </div>
        </div>

        <!-- Row 3: Treatment + LDL trend -->
        <div class="grid grid2" style="margin-top:14px">
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Por tratamiento (farmaco hospitalario)</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartTreatBar" width="400" height="220"></canvas>
            </div>
          </div>
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Evolucion LDL media (todos los pacientes)</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartLDLTrend" width="400" height="220"></canvas>
            </div>
          </div>
        </div>

        <!-- Row 4: Intervention stats -->
        <div class="grid grid3" style="margin-top:14px">
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Intervenciones por tipo</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartIVType" width="260" height="200"></canvas>
              <div class="chartLegend" id="legendIVType"></div>
            </div>
          </div>
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Estado intervenciones</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartIVStatus" width="260" height="200"></canvas>
              <div class="chartLegend" id="legendIVStatus"></div>
            </div>
          </div>
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Adherencia al tratamiento</div></div>
            <div class="cardBody cardBody--chart">
              <canvas id="chartAdherence" width="260" height="200"></canvas>
              <div class="chartLegend" id="legendAdherence"></div>
            </div>
          </div>
        </div>

        <!-- Row 5: Response table -->
        <div class="panel" style="margin-top:14px">
          <div class="panelHeader">
            <div class="panelTitle">Respuesta al tratamiento (valoracion farmaceutica)</div>
          </div>
          <div class="tableWrap">
            <table class="table" id="dash_responseTable">
              <thead>
                <tr>
                  <th>Paciente</th>
                  <th>Patologia</th>
                  <th>Nivel</th>
                  <th>Farmaco</th>
                  <th>LDL ultimo</th>
                  <th>Objetivo</th>
                  <th>Respuesta</th>
                </tr>
              </thead>
              <tbody id="dash_responseBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="interventionsView" class="view hidden">
        <div class="dashRow">
          <div class="miniCard">
            <div class="miniLabel">Total intervenciones</div>
            <div class="miniValue" id="iv_total">0</div>
          </div>
          <div class="miniCard">
            <div class="miniLabel">Aceptadas</div>
            <div class="miniValue" id="iv_accepted" style="color:var(--accent2)">0</div>
          </div>
          <div class="miniCard">
            <div class="miniLabel">Pendientes</div>
            <div class="miniValue" id="iv_pending" style="color:var(--accent)">0</div>
          </div>
        </div>
        <div class="dashRow">
          <div class="miniCard">
            <div class="miniLabel">Rechazadas</div>
            <div class="miniValue" id="iv_rejected" style="color:var(--danger)">0</div>
          </div>
          <div class="miniCard">
            <div class="miniLabel">Tasa de aceptacion</div>
            <div class="miniValue" id="iv_rate">‚Äî</div>
          </div>
          <div class="miniCard">
            <div class="miniLabel">Pacientes con intervenciones</div>
            <div class="miniValue" id="iv_patients">0</div>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="cardHeader"><div class="cardTitle">Por dimension CMO</div></div>
            <div class="cardBody" id="iv_byDimension"></div>
          </div>
          <div class="card span2">
            <div class="cardHeader"><div class="cardTitle">Por tipo de intervencion</div></div>
            <div class="cardBody" id="iv_byType"></div>
          </div>
        </div>

        <div class="panel" style="margin-top:14px">
          <div class="panelHeader">
            <div class="panelTitle">Listado de intervenciones</div>
            <div class="panelActions">
              <select id="ivFilterStatus" class="select" style="width:auto">
                <option value="">Todos los estados</option>
                <option value="accepted">Aceptadas</option>
                <option value="pending">Pendientes</option>
                <option value="rejected">Rechazadas</option>
              </select>
            </div>
          </div>
          <div class="tableWrap">
            <table class="table" id="iv_table">
              <thead>
                <tr>
                  <th>Paciente</th>
                  <th>Fecha visita</th>
                  <th>Dimension</th>
                  <th>Intervencion</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody id="iv_tbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="exportsView" class="view hidden">
        <div class="panel">
          <div class="panelHeader">
            <div>
              <div class="panelTitle">Exportaci√≥n e Importaci√≥n</div>
              <div class="smallMuted">CSV est√°ndar (sep. <b>,</b>) o Excel ES (sep. <b>;</b> + BOM) ¬∑ Backup JSON para restauraci√≥n exacta.</div>
            </div>
          </div>

          <!-- ‚îÄ‚îÄ Bloque A: Exportar CSV ‚îÄ‚îÄ -->
          <div class="exBlock">
            <div class="exBlockTitle">‚¨á Exportar CSV</div>
            <div class="smallMuted" style="margin-bottom:12px">
              <b>Est√°ndar</b>: sep. <code class="inlineCode">,</code> ¬∑ UTF-8 ¬∑ CRLF ‚Äî compatible con R, Python, Google Sheets.
              &nbsp;|&nbsp; <b>Excel ES</b>: sep. <code class="inlineCode">;</code> ¬∑ UTF-8 BOM ¬∑ para Excel en espa√±ol sin configuraci√≥n.
            </div>
            <div class="grid grid3">
              <div class="card">
                <div class="cardHeader"><div class="cardTitle">Pacientes</div></div>
                <div class="cardBody">
                  <div class="smallMuted" style="margin-bottom:10px">
                    Columnas: <code class="inlineCode">patientId</code>, <code class="inlineCode">prevalentCondition</code>, sex, birthYear, comorbidities, notes, status‚Ä¶
                  </div>
                  <div class="btnRow">
                    <button class="btn" id="btnExportPatientsCSV">‚¨á patients.csv</button>
                    <button class="btn ghost" id="btnExportPatientsCSVES">‚¨á Excel ES</button>
                    <button class="btn ghost" id="btnTemplatePatients">üìÑ Plantilla</button>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="cardHeader"><div class="cardTitle">Visitas</div></div>
                <div class="cardBody">
                  <div class="smallMuted" style="margin-bottom:10px">
                    Columnas: <code class="inlineCode">visitId</code>, <code class="inlineCode">patientId</code>, date, ldl, ldlTarget, cmoScore, priorityLevel‚Ä¶
                  </div>
                  <div class="btnRow">
                    <button class="btn" id="btnExportVisitsCSV">‚¨á visits.csv</button>
                    <button class="btn ghost" id="btnExportVisitsCSVES">‚¨á Excel ES</button>
                    <button class="btn ghost" id="btnTemplateVisits">üìÑ Plantilla</button>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="cardHeader"><div class="cardTitle">Intervenciones</div></div>
                <div class="cardBody">
                  <div class="smallMuted" style="margin-bottom:10px">
                    Columnas: <code class="inlineCode">interventionId</code>, <code class="inlineCode">patientId</code>, visitId, cmoDimension, description, status‚Ä¶
                  </div>
                  <div class="btnRow">
                    <button class="btn" id="btnExportInterventionsCSV">‚¨á interventions.csv</button>
                    <button class="btn ghost" id="btnExportInterventionsCSVES">‚¨á Excel ES</button>
                    <button class="btn ghost" id="btnTemplateInterventions">üìÑ Plantilla</button>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- /exBlock exportar -->

          <div class="divider"></div>

          <!-- ‚îÄ‚îÄ Bloque B: Importar CSV ‚îÄ‚îÄ -->
          <div class="exBlock">
            <div class="exBlockTitle">‚¨Ü Importar desde CSV</div>
            <div class="smallMuted" style="margin-bottom:12px">
              Acepta sep. <b>,</b> (est√°ndar) o <b>;</b> (Excel ES) ‚Äî detecci√≥n autom√°tica. Valida antes de guardar.
              Los registros con ID existente se <b>actualizan</b>. Para restauraci√≥n completa usa el Backup JSON.
            </div>
            <div class="grid grid3">
              <div class="card">
                <div class="cardHeader"><div class="cardTitle">Pacientes CSV</div></div>
                <div class="cardBody">
                  <div class="smallMuted" style="margin-bottom:10px">
                    Obligatorio: <code class="inlineCode">patientId</code>, <code class="inlineCode">prevalentCondition</code>
                  </div>
                  <label class="btn ghost fileBtn exImportBtn">
                    ‚¨Ü Seleccionar patients.csv
                    <input type="file" id="fileImportPatientsCSV" accept=".csv,text/csv" />
                  </label>
                  <div class="impPreview hidden" id="impPreview_patients">
                    <div class="divider" style="margin:10px 0"></div>
                    <div id="impStats_patients"></div>
                    <div class="hidden" id="impErrors_patients"></div>
                    <div class="btnRow" style="margin-top:10px">
                      <button class="btn" id="btnApply_patients" disabled>Aplicar</button>
                      <button class="btn ghost" id="btnCancel_patients">Cancelar</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="cardHeader"><div class="cardTitle">Visitas CSV</div></div>
                <div class="cardBody">
                  <div class="smallMuted" style="margin-bottom:10px">
                    Obligatorio: <code class="inlineCode">visitId</code>, <code class="inlineCode">patientId</code>, <code class="inlineCode">date</code>
                  </div>
                  <label class="btn ghost fileBtn exImportBtn">
                    ‚¨Ü Seleccionar visits.csv
                    <input type="file" id="fileImportVisitsCSV" accept=".csv,text/csv" />
                  </label>
                  <div class="impPreview hidden" id="impPreview_visits">
                    <div class="divider" style="margin:10px 0"></div>
                    <div id="impStats_visits"></div>
                    <div class="hidden" id="impErrors_visits"></div>
                    <div class="btnRow" style="margin-top:10px">
                      <button class="btn" id="btnApply_visits" disabled>Aplicar</button>
                      <button class="btn ghost" id="btnCancel_visits">Cancelar</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="cardHeader"><div class="cardTitle">Intervenciones CSV</div></div>
                <div class="cardBody">
                  <div class="smallMuted" style="margin-bottom:10px">
                    Obligatorio: <code class="inlineCode">interventionId</code>, <code class="inlineCode">patientId</code>, <code class="inlineCode">visitId</code>, <code class="inlineCode">cmoDimension</code>, <code class="inlineCode">description</code>, <code class="inlineCode">status</code>
                  </div>
                  <label class="btn ghost fileBtn exImportBtn">
                    ‚¨Ü Seleccionar interventions.csv
                    <input type="file" id="fileImportInterventionsCSV" accept=".csv,text/csv" />
                  </label>
                  <div class="impPreview hidden" id="impPreview_interventions">
                    <div class="divider" style="margin:10px 0"></div>
                    <div id="impStats_interventions"></div>
                    <div class="hidden" id="impErrors_interventions"></div>
                    <div class="btnRow" style="margin-top:10px">
                      <button class="btn" id="btnApply_interventions" disabled>Aplicar</button>
                      <button class="btn ghost" id="btnCancel_interventions">Cancelar</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card span2">
              <div class="cardHeader">
                <div class="cardTitle">Informe PDF (por navegador)</div>
              </div>
              <div class="cardBody">
                <p class="smallMuted">
                  Para PDF: abre la ficha del paciente y usa <b>Imprimir</b> ‚Üí "Guardar como PDF".
                </p>
              </div>
            </div>
          </div>

        </div>

        <!-- ‚îÄ‚îÄ Debug / self-check panel ‚Äî visible only when ?debug=1 ‚îÄ‚îÄ -->
        <div class="panel debugPanel hidden" id="debugPanel" style="margin-top:14px;border:2px solid var(--accent);background:rgba(var(--accentRGB,30,136,229),.05)">
          <div class="panelHeader">
            <div class="panelTitle" style="color:var(--accent)">üî¨ Diagn√≥stico (modo debug)</div>
            <button class="btn ghost" id="btnRunDebugCheck" style="font-size:12px">Ejecutar self-check</button>
          </div>
          <div id="debugOutput" style="font-size:12px;font-family:monospace;padding:10px 0;white-space:pre-wrap;line-height:1.6"></div>
        </div>
      </section>

      <section id="aboutView" class="view hidden">
        <div class="panel">
          <div class="panelHeader">
            <div class="panelTitle">Ayuda r√°pida</div>
          </div>
          <div class="card">
            <div class="cardBody">
              <ul class="bullets">
                <li><b>Local-first:</b> los datos se almacenan √∫nicamente en el navegador (IndexedDB); ning√∫n dato sale del dispositivo.</li>
                <li><b>RGPD:</b> utiliza exclusivamente <b>identificadores pseudonimizados</b>. No introduzcas nombre, NHC, tel√©fono ni ning√∫n otro dato personal identificativo.</li>
                <li><b>Copia de seguridad:</b> realiza exportaciones peri√≥dicas mediante ¬´Backup JSON¬ª para evitar p√©rdidas ante cambios de navegador o dispositivo.</li>
                <li><b>Exportaci√≥n:</b> genera CSV de pacientes, visitas e intervenciones para an√°lisis externos o investigaci√≥n.</li>
                <li><b>Estratificaci√≥n:</b> las variables se registran por visita y se precargan en visitas sucesivas; la puntuaci√≥n y el nivel de riesgo se calculan con cortes fijos predefinidos.</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="panel" style="margin-top:14px">
          <div class="panelHeader">
            <div class="panelTitle">Acerca de</div>
          </div>
          <div class="card">
            <div class="cardBody">
              <p style="margin:0 0 8px;font-weight:800;font-size:15px">CMO-RCV ‚Äî Herramienta de seguimiento CMO para Riesgo Cardiovascular</p>
              <p style="margin:0 0 4px;color:var(--muted);font-size:13px"><b style="color:var(--text)">Tipo de obra:</b> Programa de ordenador (aplicaci√≥n web)</p>
              <p style="margin:0 0 4px;color:var(--muted);font-size:13px"><b style="color:var(--text)">Versi√≥n:</b> v1.0</p>
              <p style="margin:0 0 4px;color:var(--muted);font-size:13px"><b style="color:var(--text)">Autor:</b> Ram√≥n Morillo</p>
              <p style="margin:0;color:var(--muted);font-size:13px"><b style="color:var(--text)">Fecha de creaci√≥n:</b> Febrero 2026</p>
            </div>
          </div>
        </div>

        <div class="panel" style="margin-top:14px">
          <div class="panelHeader">
            <div class="panelTitle">Aviso legal y condiciones de uso</div>
          </div>
          <div class="card">
            <div class="cardBody" style="font-size:12px;line-height:1.55;color:var(--muted)">
              <p style="margin:0 0 10px"><b style="color:var(--text)">1. Finalidad.</b> CMO-RCV ha sido dise√±ada como apoyo al seguimiento farmacoterap√©utico en consultas de atenci√≥n farmac√©utica hospitalaria. Su uso se permite con fines asistenciales, docentes y de investigaci√≥n dentro del marco institucional correspondiente. La herramienta no sustituye el juicio cl√≠nico del profesional ni los sistemas de historia cl√≠nica electr√≥nica del centro, y no debe utilizarse como √∫nico fundamento de decisiones terap√©uticas.</p>
              <p style="margin:0 0 10px"><b style="color:var(--text)">2. Marco regulatorio.</b> Esta herramienta no est√° concebida como producto sanitario en el sentido del Reglamento (UE) 2017/745 sobre productos sanitarios (MDR); su uso no requiere marcado CE ni registro como dispositivo m√©dico. En todo caso, el usuario deber√° observar la normativa aplicable a su actividad profesional e institucional. En materia de protecci√≥n de datos, resultan de aplicaci√≥n el Reglamento (UE) 2016/679 (RGPD) y la Ley Org√°nica 3/2018 (LOPDGDD).</p>
              <p style="margin:0 0 10px"><b style="color:var(--text)">3. Protecci√≥n de datos.</b> La herramienta funciona √≠ntegramente en el navegador del usuario (arquitectura local-first); ning√∫n dato se transmite a servidores externos ni es accesible por el autor. El usuario debe emplear √∫nicamente identificadores pseudonimizados y abstenerse de introducir datos personales identificativos (nombre, NHC, tel√©fono, etc.). El responsable del tratamiento ser√°, seg√∫n corresponda, la instituci√≥n sanitaria o el propio profesional usuario, en los t√©rminos establecidos por el RGPD y la LOPDGDD.</p>
              <p style="margin:0 0 10px"><b style="color:var(--text)">4. Uso y responsabilidades del usuario.</b> El profesional sanitario usuario es el √∫nico responsable de: (a) verificar la exactitud e integridad de los datos introducidos; (b) realizar copias de seguridad peri√≥dicas; (c) cumplir la normativa de protecci√≥n de datos y los procedimientos de seguridad de su instituci√≥n; (d) contrastar las estratificaciones y recomendaciones generadas con las gu√≠as cl√≠nicas vigentes en cada momento.</p>
              <p style="margin:0 0 10px"><b style="color:var(--text)">5. Propiedad intelectual.</b> El dise√±o, el c√≥digo fuente y los contenidos de CMO-RCV son obra del autor (Ram√≥n Morillo, Febrero 2026) y est√°n protegidos por la legislaci√≥n espa√±ola e internacional sobre propiedad intelectual. Se autoriza su uso con fines asistenciales, docentes y de investigaci√≥n dentro del marco institucional. Queda prohibida, fuera de dicho marco y sin autorizaci√≥n expresa y escrita del autor, toda reproducci√≥n, distribuci√≥n, modificaci√≥n o comunicaci√≥n p√∫blica de la herramienta o de cualquiera de sus componentes.</p>
              <p style="margin:0"><b style="color:var(--text)">6. Ausencia de garant√≠as y limitaci√≥n de responsabilidad.</b> La herramienta se proporciona ¬´tal cual¬ª (<i>AS IS</i>), sin garant√≠as de ning√∫n tipo, expresas o impl√≠citas, salvo en los casos legalmente previstos. El autor no ser√° responsable de da√±os directos, indirectos, incidentales o consecuentes derivados del uso o de la imposibilidad de uso de la herramienta, incluidos, entre otros, la p√©rdida de datos, la interrupci√≥n de la actividad asistencial o las decisiones cl√≠nicas inadecuadas, salvo en los casos legalmente previstos.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Modal: New Patient -->
      <div class="modal hidden" id="modalPatient">
        <div class="modalBackdrop" data-close="modalPatient"></div>
        <div class="modalCard modalWide">
          <div class="modalHeader">
            <div class="modalTitle">Nuevo paciente</div>
            <button class="iconBtn" data-close="modalPatient">‚úï</button>
          </div>
          <div class="modalBody">
            <div class="formGrid">
              <div class="field">
                <label>ID pseud√≥nimo *</label>
                <input class="input" id="p_patientId" placeholder="Ej. PCSK9-000123" />
                <div class="hint">No usar nombre/NIH.</div>
              </div>

              <div class="field">
                <label>Patolog√≠a prevalente *</label>
                <select class="select" id="p_condition"></select>
              </div>

              <div class="field">
                <label>Sexo</label>
                <select class="select" id="p_sex">
                  <option value="">‚Äî</option>
                  <option value="M">M</option>
                  <option value="F">F</option>
                  <option value="X">X</option>
                </select>
              </div>

              <div class="field">
                <label>A√±o de nacimiento</label>
                <input class="input" id="p_birthYear" inputmode="numeric" placeholder="Ej. 1972" />
              </div>

              <div class="field span2">
                <label>Comorbilidades (coma)</label>
                <input class="input" id="p_comorb" placeholder="Ej. DM2, ERC, ECV previa..." />
              </div>

              <div class="field span2">
                <label>Notas</label>
                <textarea class="textarea" id="p_notes" rows="3" placeholder="Barreras estables, contexto social, etc."></textarea>
              </div>

              <div class="field">
                <label>Estado</label>
                <select class="select" id="p_status">
                  <option value="active">Activo</option>
                  <option value="inactive">Inactivo</option>
                </select>
              </div>

              <div class="field">
                <label>Score estratificaci√≥n</label>
                <input class="input" id="p_score" readonly />
              </div>

              <div class="field">
                <label>Nivel/Prioridad (auto)</label>
                <input class="input" id="p_levelAuto" readonly />
              </div>

              <div class="field span2">
                <label>Estratificaci√≥n CMO ‚Äî variables basales</label>
                <div class="interventionsWrap" id="stratVarsPicker"></div>
                <div class="smallMuted">El score y nivel se recalculan al cambiar cualquier variable.</div>
              </div>
            </div>
          </div>
          <div class="modalFooter">
            <button class="btn ghost" data-close="modalPatient">Cancelar</button>
            <button class="btn" id="btnSavePatient">Guardar</button>
          </div>
        </div>
      </div>

      <!-- Modal: New Visit -->
      <div class="modal hidden" id="modalVisit">
        <div class="modalBackdrop" data-close="modalVisit"></div>
        <div class="modalCard modalWide">
          <div class="modalHeader">
            <div class="modalTitle">Nueva visita</div>
            <button class="iconBtn" data-close="modalVisit">‚úï</button>
          </div>
          <div class="modalBody">
            <div class="smallMuted" id="visitForPatient">‚Äî</div>

            <div class="formGrid">
              <div class="field">
                <label>Fecha *</label>
                <input class="input" id="v_date" type="date" />
              </div>

              <div class="field">
                <label>F√°rmaco hospitalario</label>
                <select class="select" id="v_hospDrug"></select>
              </div>

              <div class="field">
                <label>LDL (mg/dL)</label>
                <input class="input" id="v_ldl" inputmode="decimal" placeholder="Ej. 55" />
              </div>

              <div class="field">
                <label>Objetivo LDL (mg/dL)</label>
                <input class="input" id="v_ldlTarget" inputmode="decimal" placeholder="Ej. 55" />
              </div>

              <div class="field">
                <label>¬øObjetivo alcanzado?</label>
                <select class="select" id="v_goalAch">
                  <option value="">‚Äî</option>
                  <option value="true">S√≠</option>
                  <option value="false">No</option>
                </select>
              </div>

              <div class="field span2">
                <label>Tratamiento (texto libre)</label>
                <input class="input" id="v_treatment" placeholder="Ej. PCSK9 + estatina + ezetimiba..." />
              </div>

              <div class="field">
                <label>Adherencia</label>
                <input class="input" id="v_adherence" placeholder="Ej. Buena / irregular / 80%..." />
              </div>

              <div class="field">
                <label>RAM</label>
                <input class="input" id="v_ram" placeholder="Ej. reacci√≥n local, mialgias..." />
              </div>

              <div class="field span2">
                <label>Justificaci√≥n nivel (breve)</label>
                <input class="input" id="v_levelWhy" placeholder="Ej. No objetivo + cambios + baja adherencia..." />
              </div>

              <div class="field span2">
                <label>Objetivos farmacoterap√©uticos (OFT)</label>
                <textarea class="textarea" id="v_oft" rows="2"></textarea>
              </div>

              <div class="field span2">
                <label>Plan de seguimiento</label>
                <textarea class="textarea" id="v_follow" rows="2"></textarea>
              </div>

              <div class="field span2">
                <label>Intervenciones CMO (selecciona y define estado)</label>
                <div class="interventionsWrap" id="interventionsPicker"></div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="sectionTitle">Texto para HC (copy-paste)</div>
            <textarea class="textarea mono" id="v_hcText" rows="7" readonly></textarea>
            <div class="btnRow">
              <button class="btn ghost" id="btnGenerateHC">Generar texto HC</button>
              <button class="btn ghost" id="btnCopyHC">Copiar</button>
            </div>
          </div>

          <div class="modalFooter">
            <button class="btn ghost" data-close="modalVisit">Cancelar</button>
            <button class="btn" id="btnSaveVisit">Guardar visita</button>
          </div>
        </div>
      </div>

      <!-- Modal: Visit details -->
      <div class="modal hidden" id="modalVisitDetail">
        <div class="modalBackdrop" data-close="modalVisitDetail"></div>
        <div class="modalCard modalWide">
          <div class="modalHeader">
            <div class="modalTitle">Detalle visita</div>
            <button class="iconBtn" data-close="modalVisitDetail">‚úï</button>
          </div>
          <div class="modalBody">
            <div class="smallMuted" id="vd_header">‚Äî</div>
            <div class="divider"></div>
            <div class="kv" id="vd_kv"></div>
            <div class="divider"></div>
            <div class="sectionTitle">Intervenciones</div>
            <div id="vd_interventions" class="chips"></div>
          </div>
          <div class="modalFooter">
            <button class="btn ghost" data-close="modalVisitDetail">Cerrar</button>
            <button class="btn danger" id="btnDeleteVisit">Eliminar visita</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script src="./app.js?v=20260225_1000"></script>
</body>
</html>
